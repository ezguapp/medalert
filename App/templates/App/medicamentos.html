{% extends "App/base.html" %}
{% block title %}Mis Medicamentos | MedAlert{% endblock %}
{% block content %}

<section class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-primary">
      <i class="bi bi-capsule me-2"></i>Mis Medicamentos
    </h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMedicamentoModal">
      <i class="bi bi-plus-circle me-1"></i> Agregar
    </button>
  </div>

  {% if meds_info %}
  <div class="row g-4">
    {% for item in meds_info %}
      {% with m=item.obj %}
      <div class="col-md-6 col-lg-4">
        <div class="card shadow-sm border-0 h-100">
          <div class="card-body text-center">
            <h5 class="fw-semibold text-primary">{{ m.nombre }}</h5>
            <p class="small text-muted mb-1"><strong>Dosis:</strong> {{ m.dosis }}</p>
            <p class="small text-muted mb-1"><strong>Frecuencia:</strong> cada {{ m.frecuencia_horas }} horas.</p>
            <p class="small text-muted mb-1"><strong>Duraci√≥n total:</strong> {{ m.duracion_dias }} d√≠as</p>

            <p class="small text-muted mb-1">
            <strong>D√≠as restantes:</strong>
            <span>{{ item.dias_restantes|default:"‚Äî" }}</span>
            {% if item.dias_restantes == 0 %}
              <span class="badge bg-success ms-1">Completado</span>
            {% endif %}
          </p>

            {% if m.instrucciones %}
              <p class="text-muted small mb-3">{{ m.instrucciones }}</p>
            {% endif %}

            <!-- Contador -->
            <p class="small text-muted mb-2">
              ‚è± Pr√≥xima dosis en:
              {% if item.dias_restantes == 0 %}
                <span class="fw-semibold text-success">‚úÖ Tratamiento finalizado</span>
              {% else %}
                <span class="fw-semibold text-primary timer"
                      data-id="{{ m.id }}"
                      data-remaining="{{ item.restantes }}">
                  {{ item.restantes }}
                </span>
              {% endif %}
            </p>

            <!-- Bot√≥n ‚ÄúYa lo tom√©‚Äù -->
            <button class="btn btn-success btn-sm tomar-btn"
                    data-id="{{ m.id }}"
                    {% if not item.puede_tomar or item.dias_restantes == 0 %}disabled style="opacity:.6"{% endif %}>
              <i class="bi bi-check-circle me-1"></i>
              {% if item.dias_restantes == 0 %}
                Completado
              {% elif item.puede_tomar %}
                Ya lo tom√©
              {% else %}
                Esperando‚Ä¶
              {% endif %}
            </button>

            <!-- Bot√≥n eliminar -->
            <form method="post" action="" class="d-inline">
              {% csrf_token %}
              <input type="hidden" name="delete_id" value="{{ m.id }}">
              <button type="submit"
                      formaction="{% url 'eliminar_medicamento' m.id %}"
                      class="btn btn-sm btn-outline-danger ms-2">
                <i class="bi bi-trash"></i>
              </button>
            </form>

          </div>
        </div>
      </div>
      {% endwith %}
    {% endfor %}
  </div>
  {% else %}
  <div class="text-center py-5">
    <i class="bi bi-clipboard-x fs-1 text-muted"></i>
    <p class="text-muted mt-3">A√∫n no tienes medicamentos registrados.</p>
  </div>
  {% endif %}
</section>

<!-- Modal Agregar Medicamento -->
<div class="modal fade" id="addMedicamentoModal" tabindex="-1" aria-labelledby="addMedicamentoLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="{% url 'medicamentos' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addMedicamentoLabel">Agregar nuevo medicamento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" name="nombre" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Dosis</label>
            <input type="text" name="dosis" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Frecuencia (horas)</label>
            <input type="number" name="frecuencia_horas" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Duraci√≥n (d√≠as)</label>
            <input type="number" name="duracion_dias" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Instrucciones</label>
            <textarea name="instrucciones" class="form-control" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- === SCRIPT INTERACTIVO === -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const timers = document.querySelectorAll('.timer');

  const formatTime = (s) => {
    const h = String(Math.floor(s / 3600)).padStart(2, '0');
    const m = String(Math.floor((s % 3600) / 60)).padStart(2, '0');
    const sec = String(s % 60).padStart(2, '0');
    return `${h}:${m}:${sec}`;
  };

  const intervals = {};

  timers.forEach(timerEl => {
    const id = timerEl.dataset.id;
    let remaining = parseInt(timerEl.dataset.remaining || '0', 10);
    const btn = document.querySelector(`.tomar-btn[data-id="${id}"]`);

    const tick = () => {
      if (remaining <= 0) {
        clearInterval(intervals[id]);
        timerEl.textContent = "00:00:00";
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.innerHTML = '<i class="bi bi-check-circle me-1"></i> Ya lo tom√©';
        return;
      }
      timerEl.textContent = formatTime(remaining);
      remaining -= 1;
    };

    if (remaining > 0) {
      btn.disabled = true;
      btn.style.opacity = '.6';
      btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Esperando‚Ä¶';
      timerEl.textContent = formatTime(remaining);
      intervals[id] = setInterval(tick, 1000);
    } else {
      timerEl.textContent = "00:00:00";
      btn.disabled = false;
      btn.style.opacity = '1';
    }

    btn.addEventListener('click', async () => {
      if (btn.disabled) return;
      btn.disabled = true;
      btn.style.opacity = '.6';
      btn.innerHTML = 'Registrando...';

      try {
        const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const resp = await fetch(`/medicamentos/${id}/toma/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrf }
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Error');

        let r = parseInt(data.remaining_seconds, 10) || 0;
        const run = () => {
          if (r <= 0) {
            clearInterval(intervals[id]);
            timerEl.textContent = "00:00:00";
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.innerHTML = '<i class="bi bi-check-circle me-1"></i> Ya lo tom√©';
            return;
          }
          timerEl.textContent = formatTime(r);
          r--;
        };
        intervals[id] = setInterval(run, 1000);
        run();

        btn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Esperando‚Ä¶';

        const alertBox = document.createElement('div');
        alertBox.className = 'alert alert-success position-fixed top-0 start-50 translate-middle-x mt-3 shadow';
        alertBox.style.zIndex = '2000';
        alertBox.innerHTML = `<strong>üíä Toma registrada</strong>`;
        document.body.appendChild(alertBox);
        setTimeout(() => alertBox.remove(), 3000);
      } catch (e) {
        alert('Error al registrar la toma.');
        btn.disabled = false;
        btn.style.opacity = '1';
      }
    });
  });
});
</script>

{% endblock %}
